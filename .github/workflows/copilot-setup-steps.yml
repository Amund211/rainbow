name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
    workflow_dispatch:
    push:
        branches:
            - main
        paths:
            - .github/workflows/copilot-setup-steps.yml
    pull_request:
        paths:
            - .github/workflows/copilot-setup-steps.yml

jobs:
    # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
    copilot-setup-steps:
        runs-on: ubuntu-latest

        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Set up Node
              uses: actions/setup-node@v6
              with:
                  node-version: 24
                  cache: npm
                  cache-dependency-path: package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright
              run: |
                  npm install -D playwright
                  npx playwright install chromium

            - name: Start development server
              run: npm run dev:production &

            - name: Wait for server to be ready
              run: |
                  echo "Waiting for server to start..."
                  for i in {1..30}; do
                      if curl -s http://localhost:5173 > /dev/null; then
                          echo "Server is ready!"
                          exit 0
                      fi
                      echo "Attempt $i/30: Server not ready yet..."
                      sleep 2
                  done
                  echo "Server failed to start within 60 seconds"
                  exit 1

            - name: Set rainbow user ID in browser localStorage
              run: node .github/workflows/setup-browser-storage.cjs
